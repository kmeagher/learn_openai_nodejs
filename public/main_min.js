function saveUser(){localStorage.usr=JSON.stringify(user)}function saveStatus(){localStorage.lastStatus=statusCode}function loadUser(){if(200!==statusCode)return{};let e=localStorage.usr;if("string"==typeof e&&e.trim().length>0)try{return JSON.parse(e)}catch(t){console.log(t)}return{}}function loadStatus(){let e=localStorage.lastStatus;return isNaN(e)?200:parseInt(e)}const host="localhost:8080";let socket=null,statusCode=loadStatus(),user=loadUser();function startChat(){connect()}function addResponse(e,t=!1){t&&addResponse("<br />"),e=e.replace(/(?:\r\n|\r|\n)/g,"<br />");let n=document.getElementById("responses");n.innerHTML+=e,n.scrollTop=n.scrollHeight}async function postRequest(e,t={}){return new Promise(n=>{let s="string"==typeof t?t:JSON.stringify(t),a=new XMLHttpRequest;a.withCredentials=!0,a.addEventListener("readystatechange",function(){if(4===this.readyState)try{let e=JSON.parse(this.responseText);n(e)}catch(t){n({errored:!0,message:"Response Parsing Error"})}}),a.open("POST",`http://${host}/${e}`),a.setRequestHeader("Content-Type","application/json"),a.send(s)})}async function getRequest(e){return new Promise(t=>{let n=new XMLHttpRequest;n.withCredentials=!0,n.addEventListener("readystatechange",function(){if(4===this.readyState)try{let e=JSON.parse(this.responseText);t(e)}catch(n){t({errored:!0,message:"Response Parsing Error"})}}),n.open("GET",`http://${host}/${e}`),n.setRequestHeader("Content-Type","application/json"),n.send()})}function activeUser(){return user&&"string"==typeof user.token&&user.token.length>0}async function connect(){let e={errored:!0,message:"No Connection Available"};if(activeUser()){connectSocket();return}(e=await postRequest("auth/create"))&&e.errored?console.log("Error attempting to connect"):e.data&&e.data.length>0?(user=e.data[0],saveUser(),statusCode=200,saveStatus(),connectSocket()):(console.log("Authorization Response Error"),addResponse(JSON.stringify(e,null,2)))}function connectSocket(){activeUser()?(document.getElementById("welcome").classList.add("hidden"),document.getElementById("chatWindow").classList.add("hidden"),startLoader(),setTimeout(()=>{(socket=new WebSocket(`ws://${host}/ws/connect/${user.token}`)).onopen=()=>{document.getElementById("responses").innerHTML="",addResponse("Connection Open!"),addResponse("Hello! Let's get started!",!0),addResponse("Ask a math question in the area below!",!0),document.getElementById("welcome").classList.add("hidden"),document.getElementById("chatWindow").classList.remove("hidden"),document.getElementById("btnSend").removeEventListener("click",sendMessage),document.getElementById("btnSend").addEventListener("click",sendMessage),document.getElementById("btnNewChat").removeEventListener("click",newChat),document.getElementById("btnNewChat").addEventListener("click",newChat),stopLoader()},socket.onmessage=e=>{if(e.data){if(e.data.includes&&e.data.includes('"errored":true')){let t={};try{t=JSON.parse(e.data)}catch(n){t={errored:!0,message:"Unexpected Error"}}statusCode=t.statusCode||400,saveStatus(),disconnected(t);return}addResponse(e.data)}else console.log(e," => message no data")},socket.onClose=()=>{document.getElementById("welcome").classList.remove("hidden"),document.getElementById("chatWindow").classList.add("hidden"),console.log("Chat Session Has Ended")},socket.onerror=e=>{console.log(e),document.getElementById("welcome").classList.remove("hidden"),document.getElementById("chatWindow").classList.add("hidden"),alert("Chat Session has ended due to an unexpected error")}},2e3)):console.log("Authorization Error")}function sendMessage(){if(socket&&socket.readyState===socket.OPEN){let e=document.getElementById("txtPrompt").value;e.trim().length>0&&(addResponse("<br /><br />You > "+e+"<br />"),socket.send(e),document.getElementById("txtPrompt").value="")}else disconnected({message:"The connection was closed"},!1)}function disconnected(e,t=!0){e=e||{},document.getElementById("responses").innerHTML="Cannot Connect.<br />message > "+(e.message||"Unexpected Result."),t&&(user={},saveUser(),addResponse("Your session may have expired. Please reload and try again.",!0)),document.getElementById("promptArea").classList.add("hidden")}function newChat(){socket.close(),connect()}saveUser();let loading=null;function startLoader(){let e=document.getElementById("loader");e.classList.remove("hidden"),e.innerHTML="One Moment";let t=[];loading=setInterval(()=>{t.length>=4&&(t=[]),t.push("."),e.innerHTML="One Moment"+t.join("")},300)}function stopLoader(){clearInterval(loading),document.getElementById("loader").classList.add("hidden")}window.addEventListener("DOMContentLoaded",()=>{document.getElementById("btnStartChat").addEventListener("click",startChat)});